class cromaSsoClass{constructor(e,o){this.apiUrl="function"==typeof window.selectEnvironment?window.selectEnvironment("sit"):"",this.envUrl="function"==typeof window.selectTdEnvironment?window.selectTdEnvironment("sit"):"",this.cscHomeUrl="function"==typeof window.selectCscVleHomeEnv?window.selectCscVleHomeEnv("dev"):"",this.loginVersion="function"==typeof window.selectLoginJourney?window.selectLoginJourney("dev"):"",this.client_id=o,this.env=e,this.timer=0}async logIn(e="login",o="body"){if("undefined"!=typeof Storage&&"true"===localStorage.getItem("isCSC"))this.redirectToCscVleLogout();else{const o=this.IsValidJSONString(localStorage.getItem("customer_details"));o?o&&o.loyalCustomer&&"N"!==o.loyalCustomer?this.checkTdlLoaded(e):"undefined"!=typeof window&&"function"==typeof window.openLoginModal&&window.openLoginModal(!0,e):this.checkTdlLoaded(e)}}async tataDigitalWidget(e="others",o="body"){let t=window.location.href.replace("#","");"/checkout"===window.location.pathname?t=t.replace("checkout","cart"):"/payment"===window.location.pathname?t=t.replace("payment","cart"):"/order-confirmation"===window.location.pathname?t=t.replace("order-confirmation","cart"):"/login"!==window.location.pathname&&"/login/"!==window.location.pathname||(t=window.location.origin);const a="undefined"!=typeof Storage&&localStorage.getItem("orderCTA")?"undefined"!=typeof Storage&&localStorage.getItem("orderCTA"):t;"function"==typeof window.adobeRedirectCall&&(await window.adobeRedirectCall(e,"clicked",o),localStorage.setItem("logintype",e),localStorage.setItem("loginposition",o)),"undefined"!=typeof tdlSsoAuth&&void 0!==tdlSsoAuth&&tdlSsoAuth.doNativeLogin({returnURL:encodeURIComponent(a)})}redirectLogoutPage(){localStorage.removeItem("login_trigger"),localStorage.removeItem("customer_details"),localStorage.removeItem("cr-cache:user-data"),localStorage.removeItem("sessionId"),localStorage.removeItem("access_token"),localStorage.removeItem("customer_hash"),localStorage.removeItem("addressNickName"),localStorage.removeItem("gv_details"),localStorage.removeItem("gv_type"),localStorage.removeItem("userSource"),localStorage.removeItem("isCSC"),localStorage.removeItem("csc_code"),localStorage.removeItem("encryptData"),localStorage.removeItem("sltArr"),localStorage.removeItem("slots"),localStorage.removeItem("slotTime"),localStorage.removeItem("expiration"),localStorage.removeItem("selAddr"),localStorage.removeItem("reserveFailed"),localStorage.removeItem("TMSArr"),localStorage.removeItem("slot_unavailable"),localStorage.removeItem("anonymousId_tcp"),localStorage.removeItem("navigation_enabled"),-1!==window.location.pathname.search("/my-account")?window.location=window.location.origin:"/checkout"===window.location.pathname||"/payment"===window.location.pathname||"/order-confirmation"===window.location.pathname?window.location=window.location.origin+"/cart":window.location.reload()}async cromaSignOut(e,o=""){const t=localStorage.getItem("customer_hash"),a="undefined"!=typeof Storage&&"true"===localStorage.getItem("isCSC"),n=localStorage.getItem("access_token"),c=this.apiUrl+"tcp/sso/V1/signout";if(a){("function"==typeof window.cromaSso?new window.cromaSso({env:localStorage.getItem("env")}):null).redirectToCscVleLogout()}else fetch(c,{method:"POST",headers:{client_id:this.client_id,accessToken:n,customerHash:t}}).then((e=>{this.redirectLogoutPage()})).catch((e=>{this.redirectLogoutPage()}))}async fetchWishListService(e,o="GET",t,a){const n=document.head.querySelector("[name=tdl-sso-client_id][content]"),c=n?n.content:"CROMA-WEB-APP";return await fetch(`${this.apiUrl}${e}`,{method:o,headers:{client_id:c,accessToken:t,customerHash:a}})}async getWishListDetailsApi(){const e=localStorage.getItem("access_token"),o=localStorage.getItem("customer_hash");let t="";if(o&&""!==o){const a=this.IsValidJSONString(localStorage.getItem("cr-cache:user-data"));if(a&&""!==a&&a.customerInfo.customerHash){t+=`useraccount/allchannels/wishlist/v2/${a.customerInfo.customerHash}/detail?fields=MINIMUM`;const n="GET",c=await this.fetchWishListService(t,n,e,o);if(c.ok){c.headers.get("ssostatus")&&"active"===c.headers.get("ssostatus")&&localStorage.setItem("access_token",c.headers.get("accesstoken"));const e=await c.json();localStorage.setItem("defaultWishList",JSON.stringify(e))}else 401===c.status&&this.redirectToLogin()}}}async redirectToLogin(e=""){if("undefined"!=typeof Storage&&"true"===localStorage.getItem("isCSC"))this.redirectToCscVleHome();else{""!==("function"==typeof window.selectTdEnvironment?window.selectTdEnvironment():"")?"undefined"!=typeof window&&"function"==typeof window.openLoginModal&&window.openLoginModal(!0,"login"):this.redirectToCscVleHome()}}async callSignInTd(){if("function"==typeof window.adobeRedirectCall){const e=this.IsValidJSONString(localStorage.getItem("adobeLoginCall")),o=e.type?e.type:"others",t=e.position?e.position:"body",a=e.redirect_success?e.redirect_success:"redirect_success";localStorage.removeItem("adobeLoginCall"),window.adobeRedirectCall(o,a,t)}}async redirectToCuratedHomePage(){const e=window.location.origin+"/lp-csc-grameen-estore";window.location=e}async redirectToCscVleHome(){const e="function"==typeof window.selectCscVleHomeEnv?window.selectCscVleHomeEnv("dev"):"";window.location=e}async redirectToCscVleLogout(){const e={csc_code:localStorage.getItem("csc_code"),access_token:localStorage.getItem("access_token")},o="function"==typeof window.selectEnvironment?window.selectEnvironment("dev"):"";fetch(o+"csc/v1/vle-logout",{method:"POST",body:JSON.stringify(e)}).then((e=>e.json())).then((e=>{localStorage.removeItem("customer_details"),localStorage.removeItem("cr-cache:user-data"),localStorage.removeItem("access_token"),localStorage.removeItem("sessionId"),localStorage.removeItem("customer_hash"),localStorage.removeItem("addressNickName"),localStorage.removeItem("gv_details"),localStorage.removeItem("gv_type"),localStorage.removeItem("isCSC"),localStorage.removeItem("csc_code"),localStorage.removeItem("anonymousId_tcp"),localStorage.removeItem("userSource"),localStorage.removeItem("encryptData");const o="function"==typeof window.selectCscVleLogoutEnv?window.selectCscVleLogoutEnv("dev"):"";window.location=o})).catch((e=>{console.log(e)}))}IsValidJSONString(e){try{return JSON.parse(e)}catch(e){return""}}async globalSignIn(e="",o="",t="",a="sit"){let n="undefined"!=typeof window&&window.location.href;const c=this.IsValidJSONString(localStorage.getItem("cr-cache:guest-cart"),"token"),i=this.apiUrl+`tcp/sso/V2/access-token/${e}`;c&&""!==c?fetch(i,{method:"POST",body:JSON.stringify({codeVerifier:o}),headers:{cartGuid:c.guid,client_id:this.client_id}}).then((e=>{if(!e.ok)throw Error(e.statusText);return e.headers.get("customerhash")&&e.headers.get("accesstoken")?this.saveTokenInStorage(e):this.loginFailedRedirect(n),e.json()})).then((e=>{this.saveDataInStorage(e,n)})).catch((e=>{this.loginFailedRedirect(n)})):fetch(i,{method:"POST",body:JSON.stringify({codeVerifier:o}),headers:{client_id:this.client_id}}).then((e=>{if(!e.ok)throw Error(e.statusText);return e.headers.get("customerhash")&&e.headers.get("accesstoken")?this.saveTokenInStorage(e):this.loginFailedRedirect(n),e.json()})).then((e=>{this.saveDataInStorage(e,n)})).catch((e=>{this.loginFailedRedirect(n)}))}saveTokenInStorage(e){localStorage.setItem("customer_hash",e.headers.get("customerhash")),localStorage.setItem("access_token",e.headers.get("accesstoken"))}saveDataInStorage(e,o){const t=e,a=e.customerInfo;if(a&&(localStorage.setItem("customer_details",JSON.stringify(a)),a.addresses&&Array.isArray(a.addresses)&&!localStorage.getItem("3hrPincode"))){const e=a.addresses.find((e=>"true"==e.isPrimary));e&&e.pinCode&&localStorage.setItem("3hrPincode",JSON.stringify(e.pinCode))}t.customerInfo=a,localStorage.setItem("cr-cache:user-data",JSON.stringify(t)),localStorage.setItem("encryptData","true");let n=localStorage.getItem("logintype")?localStorage.getItem("logintype"):"others";"tcp"===localStorage.getItem("userSource")&&(n="tcp"),localStorage.removeItem("cr-cache:guest-cart");const c={redirect_success:"redirect_success",type:n,position:localStorage.getItem("loginposition")?localStorage.getItem("loginposition"):"body"};if(localStorage.setItem("adobeLoginCall",JSON.stringify(c)),"function"==typeof window.adobeRedirectCall){const e=localStorage.getItem("logintype")?localStorage.getItem("logintype"):"others",o=localStorage.getItem("loginposition")?localStorage.getItem("loginposition"):"body";window.adobeRedirectCall(e,"redirect_success",o)}localStorage.setItem("adobeLoginCall",JSON.stringify(c)),this.loginFailedRedirect(o)}loginFailedRedirect(e){"/checkout"===window.location.pathname?e=e.replace("checkout","cart"):"/payment"===window.location.pathname?e=e.replace("payment","cart"):"/order-confirmation"===window.location.pathname?e=e.replace("order-confirmation","cart"):"/login"!==window.location.pathname&&"/login/"!==window.location.pathname||(e=window.location.origin);let o=new URL(e);window.open(o,"_parent")}async checkTdlLoaded(e=""){if("undefined"!=typeof tdlSsoAuth&&void 0!==tdlSsoAuth)if(localStorage.getItem("access_token")){const o=this.IsValidJSONString(localStorage.getItem("customer_details"));if(o&&o.loyalCustomer&&"N"!==o.loyalCustomer){const o="useractivity/allchannels/v1/tracker",t=localStorage.getItem("customer_hash"),a=localStorage.getItem("access_token"),n=await this.fetchWishListService(o,"GET",a,t);if(n.ok&&n.headers.get("ssostatus")&&"active"===n.headers.get("ssostatus")?localStorage.setItem("ssostatus","active"):localStorage.setItem("ssostatus","expired"),"expired"===localStorage.getItem("ssostatus"))try{tdlSsoAuth.getSession().then((o=>{const t=localStorage.getItem("userSource");o.authCode&&"tcp"!=t?this.globalSignIn(o.authCode,o.codeVerifier):""!==e&&"checkGlobalLogin"!==e?"undefined"!=typeof window&&"function"==typeof window.openLoginModal&&window.openLoginModal(!0,e):this.cromaSignOut(localStorage.getItem("access_token"),"global_signout")}))}catch(e){console.log(e)}}else""!==e&&"checkGlobalLogin"!==e&&"undefined"!=typeof window&&"function"==typeof window.openLoginModal&&window.openLoginModal(!0,e)}else try{tdlSsoAuth.getSession().then((o=>{const t=localStorage.getItem("userSource");o.authCode&&"tcp"!=t?this.globalSignIn(o.authCode,o.codeVerifier):""!==e&&"checkGlobalLogin"!==e&&"undefined"!=typeof window&&"function"==typeof window.openLoginModal&&window.openLoginModal(!0,e)}))}catch(o){"undefined"!=typeof window&&"function"==typeof window.openLoginModal&&window.openLoginModal(!0,e)}else this.timer<3?(this.timer=this.timer+1,setTimeout((()=>{this.checkTdlLoaded(e).then((e=>{console.log(e)})).catch((e=>{console.log(e)}))}),500)):(""==e&&(e="login"),"checkGlobalLogin"!==e&&"undefined"!=typeof window&&"function"==typeof window.openLoginModal&&window.openLoginModal(!0,e))}createSession(e){try{if("undefined"!=typeof tdlSsoAuth&&void 0!==tdlSsoAuth)try{tdlSsoAuth.createSession(e)}catch(e){console.log(e)}}catch(e){console.log(e)}}}function cromaSso(e){const o=document.head.querySelector("[name=tdl-sso-client_id][content]");let t="";t=o?o.content:"CROMA-WEB-APP";const{env:a="sit",client_id:n=t}=e||{};return new cromaSsoClass(a,n)}!function(){const e="function"==typeof window.cromaSso?new window.cromaSso({env:localStorage.getItem("env")}):null;if(null!==e){localStorage.getItem("loginRedirectedUrl")&&(localStorage.removeItem("loginRedirectedUrl"),e.cromaSignOut().then((e=>{console.log(e)})).catch((e=>{console.log(e)})));if(localStorage.getItem("adobeLoginCall"))setTimeout((()=>{e.callSignInTd().then((e=>{console.log(e)})).catch((e=>{console.log(e)}))}),0);else{const o=window.location.search,t=new URLSearchParams(o);"null"==decodeURIComponent(t.get("authCode"))&&setTimeout((()=>{e.checkTdlLoaded("checkGlobalLogin").then((e=>{console.log(e)})).catch((e=>{console.log(e)}))}),0)}}}();